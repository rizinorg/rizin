NAME=fmul 1.5 * 1.25
FILE=malloc://512
CMDS=<<EOF
e asm.arch=avr
wa "ldi r16, 0xC0 ; ldi r17, 0xA0 ; fmul r16, r17"
aezi
aezse 3
EOF
EXPECT=<<EOF
pc_write(old: 0x0, new: 0x2)
var_write(name: r16, old: 0x0, new: 0xc0)
pc_write(old: 0x2, new: 0x4)
var_write(name: r17, old: 0x0, new: 0xa0)
pc_write(old: 0x4, new: 0x6)
var_write(name: r1, old: 0x0, new: 0xf0)
var_write(name: r0, old: 0x0, new: 0x0)
var_write(name: zf, old: 0x0, new: 0x0)
var_write(name: cf, old: 0x0, new: 0x1)
EOF
RUN

NAME=fmul test 2
FILE=malloc://512
CMDS=<<EOF
e asm.arch=avr
wa "ldi r16, 0xec ; ldi r17, 0x17 ; fmul r16, r17"
aezi
aezse 3
EOF
EXPECT=<<EOF
pc_write(old: 0x0, new: 0x2)
var_write(name: r16, old: 0x0, new: 0xec)
pc_write(old: 0x2, new: 0x4)
var_write(name: r17, old: 0x0, new: 0x17)
pc_write(old: 0x4, new: 0x6)
var_write(name: r1, old: 0x0, new: 0x2a)
var_write(name: r0, old: 0x0, new: 0x68)
var_write(name: zf, old: 0x0, new: 0x0)
var_write(name: cf, old: 0x0, new: 0x0)
EOF
RUN

NAME=fmuls -0.75 * -0.125
FILE=malloc://512
CMDS=<<EOF
e asm.arch=avr
wa "ldi r16, 0xA0 ; ldi r17, 0xF0 ; fmuls r16, r17"
aezi
aezse 3
EOF
EXPECT=<<EOF
pc_write(old: 0x0, new: 0x2)
var_write(name: r16, old: 0x0, new: 0xa0)
pc_write(old: 0x2, new: 0x4)
var_write(name: r17, old: 0x0, new: 0xf0)
pc_write(old: 0x4, new: 0x6)
var_write(name: r1, old: 0x0, new: 0xc)
var_write(name: r0, old: 0x0, new: 0x0)
var_write(name: zf, old: 0x0, new: 0x0)
var_write(name: cf, old: 0x0, new: 0x0)
EOF
RUN

NAME=fmuls test 2
FILE=malloc://512
CMDS=<<EOF
e asm.arch=avr
wa "ldi r16, 0x0f ; ldi r17, 0x1f ; fmuls r16, r17"
aezi
aezse 3
EOF
EXPECT=<<EOF
pc_write(old: 0x0, new: 0x2)
var_write(name: r16, old: 0x0, new: 0xf)
pc_write(old: 0x2, new: 0x4)
var_write(name: r17, old: 0x0, new: 0x1f)
pc_write(old: 0x4, new: 0x6)
var_write(name: r1, old: 0x0, new: 0x3)
var_write(name: r0, old: 0x0, new: 0xa2)
var_write(name: zf, old: 0x0, new: 0x0)
var_write(name: cf, old: 0x0, new: 0x0)
EOF
RUN

NAME=fmulsu -0.5 * 0.75
FILE=malloc://512
CMDS=<<EOF
e asm.arch=avr
wa "ldi r16, 0xc0 ; ldi r17, 0x60 ; fmulsu r16, r17"
aezi
aezse 3
EOF
EXPECT=<<EOF
pc_write(old: 0x0, new: 0x2)
var_write(name: r16, old: 0x0, new: 0xc0)
pc_write(old: 0x2, new: 0x4)
var_write(name: r17, old: 0x0, new: 0x60)
pc_write(old: 0x4, new: 0x6)
var_write(name: r1, old: 0x0, new: 0xd0)
var_write(name: r0, old: 0x0, new: 0x0)
var_write(name: zf, old: 0x0, new: 0x0)
var_write(name: cf, old: 0x0, new: 0x1)
EOF
RUN

NAME=fmulsu test 2
FILE=malloc://512
CMDS=<<EOF
e asm.arch=avr
wa "ldi r16, 0xff ; ldi r17, 0x50 ; fmulsu r16, r17"
aezi
aezse 3
EOF
EXPECT=<<EOF
pc_write(old: 0x0, new: 0x2)
var_write(name: r16, old: 0x0, new: 0xff)
pc_write(old: 0x2, new: 0x4)
var_write(name: r17, old: 0x0, new: 0x50)
pc_write(old: 0x4, new: 0x6)
var_write(name: r1, old: 0x0, new: 0xb0)
var_write(name: r0, old: 0x0, new: 0xa0)
var_write(name: zf, old: 0x0, new: 0x0)
var_write(name: cf, old: 0x0, new: 0x1)
EOF
RUN

NAME=push & pop
FILE=malloc://512
CMDS=<<EOF
e asm.arch=avr
wa "ldi r16, 0xC0 ; ldi r17, 0xA0 ; push r16 ; push r17 ; pop r16 ; pop r17"
aezi
ar SP=0x3F
aezs 2
ar r16
ar r17
aezs 1
ar sp
px 16 @ 0x30
aezs 1
ar sp
px 16 @ 0x30
aezs 1
ar r16
ar sp
aezs 1
ar r17
ar sp
EOF
EXPECT=<<EOF
r16 = 0x000000c0
r17 = 0x000000a0
sp = 0x0000003e
- offset -   0 1  2 3  4 5  6 7  8 9  A B  C D  E F  0123456789ABCDEF
0x00000030  0000 0000 0000 0000 0000 0000 0000 00c0  ................
sp = 0x0000003d
- offset -   0 1  2 3  4 5  6 7  8 9  A B  C D  E F  0123456789ABCDEF
0x00000030  0000 0000 0000 0000 0000 0000 0000 a0c0  ................
r16 = 0x000000a0
sp = 0x0000003e
r17 = 0x000000c0
sp = 0x0000003f
EOF
RUN

NAME=Subtract r17:r16 from r31:r30
FILE=malloc://512
CMDS=<<EOF
e asm.arch=avr
wa "ldi r17, 0x72 ; ldi r16, 0x50 ; ldi r31, 0x11 ; ldi r30, 0xEE ; sub r30, r16 ; sbc r31, r17"
aezi
aezs 4
ar r17
ar r16
ar r31
ar r30
aezse 2~name
ar r31
ar r30
EOF
EXPECT=<<EOF
r17 = 0x00000072
r16 = 0x00000050
r31 = 0x00000011
r30 = 0x000000ee
var_write(name: zf, old: 0x0, new: 0x0)
var_write(name: hf, old: 0x0, new: 0x0)
var_write(name: vf, old: 0x0, new: 0x0)
var_write(name: nf, old: 0x0, new: 0x1)
var_write(name: cf, old: 0x0, new: 0x0)
var_write(name: sf, old: 0x0, new: 0x1)
var_write(name: r30, old: 0xee, new: 0x9e)
var_write(name: zf, old: 0x0, new: 0x0)
var_write(name: hf, old: 0x0, new: 0x1)
var_write(name: vf, old: 0x0, new: 0x0)
var_write(name: nf, old: 0x0, new: 0x1)
var_write(name: cf, old: 0x0, new: 0x1)
var_write(name: sf, old: 0x0, new: 0x1)
var_write(name: r31, old: 0x11, new: 0x9f)
r31 = 0x0000009f
r30 = 0x0000009e
EOF
RUN

NAME=Subtract r17:r16 from r31:r30
FILE=malloc://512
CMDS=<<EOF
e asm.arch=avr
wa "ldi r31, 0x11 ; ldi r30, 0xEE ; subi r30, 0x50 ; sbci r31, 0x72"
aezi
aezs 2
ar r31
ar r30
aezse 2~name
ar r31
ar r30
EOF
EXPECT=<<EOF
r31 = 0x00000011
r30 = 0x000000ee
var_write(name: zf, old: 0x0, new: 0x0)
var_write(name: hf, old: 0x0, new: 0x0)
var_write(name: vf, old: 0x0, new: 0x0)
var_write(name: nf, old: 0x0, new: 0x1)
var_write(name: cf, old: 0x0, new: 0x0)
var_write(name: sf, old: 0x0, new: 0x1)
var_write(name: r30, old: 0xee, new: 0x9e)
var_write(name: zf, old: 0x0, new: 0x0)
var_write(name: hf, old: 0x0, new: 0x1)
var_write(name: vf, old: 0x0, new: 0x0)
var_write(name: nf, old: 0x0, new: 0x1)
var_write(name: cf, old: 0x0, new: 0x1)
var_write(name: sf, old: 0x0, new: 0x1)
var_write(name: r31, old: 0x11, new: 0x9f)
r31 = 0x0000009f
r30 = 0x0000009e
EOF
RUN

NAME=Perform SWAP
FILE=malloc://512
CMDS=<<EOF
e asm.arch=avr
wa "inc r1 ; swap r1 ; inc r1 ; swap r1 ; inc r1"
aezi
?e increase r1
aezs
ar r1
?e swap nibbles
aezs
ar r1
?e increase r1
aezs
ar r1
?e swap nibbles
aezs
ar r1
?e increase r1
aezs
ar r1
EOF
EXPECT=<<EOF
increase r1
r1 = 0x00000001
swap nibbles
r1 = 0x00000010
increase r1
r1 = 0x00000011
swap nibbles
r1 = 0x00000011
increase r1
r1 = 0x00000012
EOF
RUN

NAME=Add r17:r16 to r31:r30
FILE=malloc://512
CMDS=<<EOF
e asm.arch=avr
wa "ldi r17, 0x7f" @ 0x0
wa "ldi r16, 0x50" @ 0x2
wa "ldi r31, 0x11" @ 0x4
wa "ldi r30, 0xEE" @ 0x6
wa "add r30, r16" @ 0x8
wa "adc r31, r17" @ 0xa   
aezi
aezse 4~name
?e add
aezse
?e add with carry
aezse
EOF
EXPECT=<<EOF
var_write(name: r17, old: 0x0, new: 0x7f)
var_write(name: r16, old: 0x0, new: 0x50)
var_write(name: r31, old: 0x0, new: 0x11)
var_write(name: r30, old: 0x0, new: 0xee)
add
pc_write(old: 0x8, new: 0xa)
var_write(name: hf, old: 0x0, new: 0x0)
var_write(name: vf, old: 0x0, new: 0x0)
var_write(name: nf, old: 0x0, new: 0x0)
var_write(name: zf, old: 0x0, new: 0x0)
var_write(name: cf, old: 0x0, new: 0x1)
var_write(name: sf, old: 0x0, new: 0x0)
var_write(name: r30, old: 0xee, new: 0x3e)
add with carry
pc_write(old: 0xa, new: 0xc)
var_write(name: hf, old: 0x0, new: 0x1)
var_write(name: vf, old: 0x0, new: 0x1)
var_write(name: nf, old: 0x0, new: 0x1)
var_write(name: zf, old: 0x0, new: 0x0)
var_write(name: cf, old: 0x1, new: 0x0)
var_write(name: sf, old: 0x0, new: 0x0)
var_write(name: r31, old: 0x11, new: 0x91)
EOF
RUN

