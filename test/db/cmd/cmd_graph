NAME=one node
FILE==
CMDS=<<EOF
agn title1 body1
agg k~nodes=
agg k~nodes.title1.body
agg k~nodes.title1.w
agg k~nodes.title1.h
EOF
EXPECT=<<EOF
agraph.nodes=title1
agraph.nodes.title1.body=base64:Ym9keTE=
agraph.nodes.title1.w=0xc
agraph.nodes.title1.h=0x4
EOF
RUN

NAME=two nodes
FILE==
CMDS=<<EOF
agn "Title with super long text and space" body1
agn title2 "SuperLongBodyWithALot Of text and spaces"
agg k~nodes=
agg k~nodes.Title with super long text and space.body=
agg k~nodes.title2.body=
agg k~nodes.Title with super long text and space.w
agg k~nodes.Title with super long text and space.h
agg k~nodes.title2.w
agg k~nodes.title2.h
EOF
EXPECT=<<EOF
agraph.nodes=Title with super long text and space,title2
agraph.nodes.Title with super long text and space.body=base64:Ym9keTE=
agraph.nodes.title2.body=base64:U3VwZXJMb25nQm9keVdpdGhBTG90IE9mIHRleHQgYW5kIHNwYWNlcw==
agraph.nodes.Title with super long text and space.w=0x2a
agraph.nodes.Title with super long text and space.h=0x4
agraph.nodes.title2.w=0x2c
agraph.nodes.title2.h=0x4
EOF
RUN

NAME=base64 body
FILE==
CMDS=<<EOF
agn title1 base64:aGVsbG8gd29ybGQ=
agg k~nodes.title1.body=
EOF
EXPECT=<<EOF
agraph.nodes.title1.body=base64:aGVsbG8gd29ybGQ=
EOF
RUN

NAME=long base64 body
FILE==
CMDS=<<EOF
agn title1 base64:dGhpcyBpcyBhIHZlcnkgbG9uZyB0ZXh0IHRoYXQgd2hlbiBlbmNvZGVkIHdpbGwgY2F1c2UgYSAKIGluIHRoZSBiYXNlNjQ=
agg k~nodes.title1.body=
EOF
EXPECT=<<EOF
agraph.nodes.title1.body=base64:dGhpcyBpcyBhIHZlcnkgbG9uZyB0ZXh0IHRoYXQgd2hlbiBlbmNvZGVkIHdpbGwgY2F1c2UgYSAKIGluIHRoZSBiYXNlNjQ=
EOF
RUN

NAME=two nodes same title
FILE==
CMDS=<<EOF
agn title1 body1
agn title1 "Super long body with something"
agn title1 "Super super super long body to do tests........"
agg k~nodes=
agg k~nodes.title1.body=
agg k~nodes.title1.w=
EOF
EXPECT=<<EOF
agraph.nodes=title1
agraph.nodes.title1.body=base64:Ym9keTE=
agraph.nodes.title1.w=0xc
EOF
RUN

NAME=remove node
FILE==
CMDS=<<EOF
agn title1 body1
agn- title1
agg k~nodes=
agg k~nodes.title1
EOF
EXPECT=<<EOF
EOF
RUN

NAME=remove node with title that contain spaces
FILE==
CMDS=<<EOF
agn "Title with spaces" body1
agn- "Title with spaces"
agg k~nodes=
agg k~nodes.Title with spaces
EOF
EXPECT=<<EOF
EOF
RUN

NAME=remove non-existent node
FILE==
CMDS=<<EOF
agn "Title with spaces" body1
agn- NotValid
agg k~nodes=
agg k~nodes.Title with spaces.body=
EOF
EXPECT=<<EOF
agraph.nodes=Title with spaces
agraph.nodes.Title with spaces.body=base64:Ym9keTE=
EOF
RUN

NAME=remove edge
FILE==
CMDS=<<EOF
agn "Title with spaces" body1
agn "Title with spaces 2" body2
age- "Title with spaces" "Title with spaces 2"
agg k~nodes=
agg k~nodes.Title with spaces.neighbours=
EOF
EXPECT=<<EOF
agraph.nodes=Title with spaces,Title with spaces 2
EOF
RUN

NAME=get graph of a function
FILE=bins/elf/analysis/hello-linux-x86_64
BROKEN=1
CMDS=<<EOF
af
agg k $$~nodes=
EOF
EXPECT=<<EOF
agraph.nodes=0x400410
EOF
RUN

NAME=no selected node in non-interactive
FILE==
CMDS=<<EOF
agn title1 body1
agg
EOF
EXPECT=<<EOF
.----------.
|  title1  |
| body1    |
`----------'
EOF
RUN

NAME=agf one
FILE==
CMDS=<<EOF
e asm.arch=x86
e asm.bits=32
e asm.calls=false
wa "push ebp;mov ebp,esp;pop ebp;ret"
af
agf
EOF
EXPECT=<<EOF
.-----------------.
|  0x0            |
| fcn.00000000(); |
| push ebp        |
| mov ebp, esp    |
| pop ebp         |
| ret             |
`-----------------'
EOF
RUN

NAME=agg one
FILE==
CMDS=<<EOF
agn 0x0 base64:cHVzaCBlYnAKbW92IGVicCwgZXNwCnBvcCBlYnAKcmV0
agg
EOF
EXPECT=<<EOF
.--------------.
|  0x0         |
| push ebp     |
| mov ebp, esp |
| pop ebp      |
| ret          |
`--------------'
EOF
RUN

NAME=graph size
FILE==
CMDS=<<EOF
agg k~agraph.w=
agg k~agraph.h=
agn title1 body1
agg k~agraph.w=
agg k~agraph.h=
EOF
EXPECT=<<EOF
agraph.w=0
agraph.h=0
agraph.w=12
agraph.h=7
EOF
RUN

NAME=graph size with edges
FILE==
CMDS=<<EOF
agn title1 body1
agn title2 "body2 long body with a lot of spaces and dots...."
agn title3 body3
age title1 title2
age title2 title3
age title1 title3
age title3 title1
agg k~agraph.w=0x35
agg | head -2 | tail -1 | tr -d " " | grep "=----------------="
EOF
EXPECT=<<EOF
EOF
RUN

NAME=graph size with self-referenced bb
FILE==
CMDS=<<EOF
agn title1 body1
age title1 title1
agg k~agraph.w=0x16
agg k~agraph.h=0x4
EOF
EXPECT=<<EOF
EOF
RUN

NAME=graph title
FILE==
CMDS=<<EOF
agn title1 body1
e graph.title="This is the graph title"
agg
EOF
EXPECT=<<EOF
This is the graph title
.----------.
|  title1  |
| body1    |
`----------'
EOF
RUN

NAME=print r2 commands to create graph
FILE==
CMDS=<<EOF
agn title1 body1
agn title2 body2
agn title3 base64:dGhpcyBpcyBteSBib2R5CndpdGggbmV3bGluZXM=
age title1 title2
age title3 title1
agg *
EOF
EXPECT=<<EOF
agn "title3" base64:dGhpcyBpcyBteSBib2R5CndpdGggbmV3bGluZXM=
agn "title2" base64:Ym9keTI=
agn "title1" base64:Ym9keTE=
age "title3" "title1"
age "title1" "title2"
EOF
RUN

NAME=graph self-ref block
FILE==
CMDS=<<EOF
agn title1 body1
age title1 title1
agg
EOF
EXPECT=<<EOF
.----.
|    |
|.----------.
||  title1  |
|| body1    |
|`----------'
|    v
|    |
`----'
EOF
RUN

NAME=with analysis.nopskip
FILE=bins/elf/analysis/ls-alxchk
CMDS=<<EOF
e analysis.nopskip=true
aaa
s 0x00011390
agf > /dev/null
EOF
EXPECT=<<EOF
EOF
RUN

NAME=super mario block (#8788)
FILE=bins/elf/analysis/hello-android-mips
CMDS=<<EOF
e emu.str=true
e io.cache=true
s 0x0008049c
af+ super_mario_fix @ 0x0008049c
afb+ 0x0008049c 0x0008049c 8
wx c2a2c2a2c2a2 @ 0x80510
e str.search.encoding=utf8
agf
e scr.strconv=asciidot
agf
EOF
EXPECT=<<EOF
.--------------------------------------------.
|  0x8049c                                   |
| super_mario_fix();                         |
|    ; segment.ehdr                          |
| lui v0, 8                                  |
|    ; "\u00a2\u00a2\u00a2World" sym..rodata |
| addiu a0, v0, 0x510                        |
`--------------------------------------------'
.-----------------------------.
|  0x8049c                    |
| super_mario_fix();          |
|    ; segment.ehdr           |
| lui v0, 8                   |
|    ; "...World" sym..rodata |
| addiu a0, v0, 0x510         |
`-----------------------------'
EOF
RUN

NAME=agf
FILE=bins/mach0/ls-osx-x86_64
CMDS=<<EOF
af
agf > /dev/null
EOF
EXPECT=<<EOF
EOF
RUN

NAME=Test iCFG generation
FILE=bins/elf/analysis/x86_icfg_test
CMDS=<<EOF
aac
aap
agCi
EOF
EXPECT=<<EOF
.------.
|      |
|.-------------.   .-------------.         .-------------.
||  0x80000fe  |   |  0x80001d8  |         |  0x800028a  |
|`-------------'   `-------------'         `-------------'
|          t                                     t
|          |                                     |
|       .--'                                     |
|       |                                        |
|       |                                  .-------------.
|       |                                  |  0x800026f  |
|       |                                  `-------------'
|       |                                        t
|       |                                        |
|       |                         .--------------|
|       |                         |              '---------------.
|       |                         |                              |
|       |                   .-------------.                .-------------.
|       |                   |  0x80000c0  |                |  0x8000254  |
|       |                   `-------------'                `-------------'
|       |                         v   v                          t
|       |                         |   |                          |
|       |                         |   '-------------.            |
|       |                     .---|                 |            |
|       |         .---------------|                 |            |
|       |         |           |   '-----.           |            |
|       |         |           |         |           |   .--------|
|       |         |           |         |           |   |        '---------.
|       |         |           |         |           |   |                  |
|       |   .-------------.   |   .-------------.   |   |            .-------------.
|       |   |  0x800006c  |   |   |  0x8000082  |   |   |            |  0x8000239  |
|       |   `-------------'   |   `-------------'   |   |            `-------------'
|       |                     |         t   t       |   |                  t
|       |                     |         |   |       |   |                  |
|       |                     |         |   |       |   |                  |
|       |                 .---|---------'   |       |   |                  |
|       |                 |   |             |       |   |         .--------|
|       |                 |   |             |       |   |         |        '--------.
|       |                 .---'             |       |   |         |                 |
|       |                 |                 .-------'   |         |                 |
|       |                 |                 |           |         |                 |
|       |           .-------------.   .-------------.   |   .-------------.   .-------------.
|       |           |  0x8000056  |   |  0x8000040  |   |   |  0x80001e8  |   |  0x8000228  |
|       |           `-------------'   `-------------'   |   `-------------'   `-------------'
|       |                                               |         t                 t
|       |                                               |         |                 |
|       |     .-----------------------------------------|---------|                 |
|       |     |           .-----------------------------|---------'                 |
|       |     |           |   .-------------------------|---------------------------'
|       '-----.           |   |                         |
|             .-----------------------------------------'
|             |           |   |
|       .-------------.   |   |
|       |  0x8000160  |   |   |
|       `-------------'   |   |
|             t           |   |
|             |           |   |
|      .------'           |   |
|      .------------------'   |
|      |                 .----'
|      |                 .---------.
|      |                 |         |
|.-------------.   .-------------. |
||  0x800012f  |   |  0x800019c  | |
|`-------------'   `-------------' |
|      t                 t         |
|      |                 |         |
`------'                 |         |
                         `---------'
EOF
RUN

NAME=Test CFG generation - all
FILE=bins/elf/analysis/x86_cfg_test
CMDS=<<EOF
s sym.main
agF
EOF
EXPECT=<<EOF
                                  .-----------------.
                                  |  0x8000040 (e)  |
                                  `-----------------'
                                      v
                                      |
                                      |
                                  .-----------------.
                                  |  0x8000041 (.)  |
                                  `-----------------'
                                      v
                                      |
                                      |
                                  .-----------------.
                                  |  0x8000044 (.)  |
                                  `-----------------'
                                      v
                                      |
                                      |
                                  .-----------------.
                                  |  0x8000048 (.)  |
                                  `-----------------'
                                      v
                                      |
                                      |
                                  .-----------------.
                                  |  0x800004f (C)  |
                                  `-----------------'
                                      v
                                      |
                                      |
                                  .-----------------.
                                  |  0x8000054 (.)  |
                                  `-----------------'
                                      v
                                      |
                                      |
                                  .-----------------.
                                  |  0x8000057 (.)  |
                                  `-----------------'
                                      v
                                      |
                                      |
                                  .-----------------.
                                  |  0x8000059 (.)  |
                                  `-----------------'
                                      v
                                      |
                                      |
                                  .-----------------.
                                  |  0x800005c (.)  |
                                  `-----------------'
                                      v
                                      |
                                     .'
                                     |
                                 .------------------.
                                 |  0x8000063 (jc)  |
                                 `------------------'
                                       t f
                                       | |
                           .-----------' |
                           |             '-------.
                           |                     |
                       .-----------------.   .-----------------.
                       |  0x8000067 (.)  |   |  0x8000065 (j)  |
                       `-----------------'   `-----------------'
                           v                     v
                           |                     |
                      .----'                     |
                      |                       .--'
                      |                       |
                  .------------------.        |
                  |  0x800006b (jc)  |        |
                  `------------------'        |
                        t f                   |
                        | |                   |
               .--------' |                   |
               |          '-------------------|--------.
               |                              '--------------------------------.
               |                                       |                       | .-----------.
               |                                       |                       | |           |
           .-----------------.                     .-----------------.   .-----------------. |
           |  0x8000074 (.)  |                     |  0x800006d (.)  |   |  0x8000090 (j)  | |
           `-----------------'                     `-----------------'   `-----------------' |
               v                                       v                     v               |
               |                                       |                     |               |
               |                                       |                     `---------------'
              .'                                       |
              |                                    .---'
              |                                    |
          .------------------.                 .-----------------.
          |  0x8000078 (jc)  |                 |  0x8000072 (j)  |
          `------------------'                 `-----------------'
                t f                                v
                | |                                |
                | |                                '----.
    .-----------' |                                     |
    |             '-------.                             |
    |                     |                             |
.-----------------.   .-----------------.               |
|  0x8000088 (.)  |   |  0x800007a (j)  |               |
`-----------------'   `-----------------'               |
    v                     v                             |
    |                     |                             |
    '----.                |                             |
         |                '.                            |
         |                 | .----------------------------.
         |                 | |                          | |
         |           .-----------------.                | |
         |           |  0x8000080 (.)  |                | |
         |           `-----------------'                | |
         |               v                              | |
         |               |                              | |
         |              .'                              | |
         |              |                               | |
         |          .------------------.                | |
         |          |  0x8000084 (jc)  |                | |
         |          `------------------'                | |
         |                  f t                         | |
         |                  | |                         | |
         |                  | '-------.                 | |
         |      .-----------'         |                 | |
         |      |                     |                 | |
         |  .-----------------.   .-----------------.   | |
         |  |  0x8000086 (j)  |   |  0x800007c (.)  |   | |
         |  `-----------------'   `-----------------'   | |
         |      v                     v                 | |
         |      |                     |                 | |
         |      |                     `-------------------'
         |  .---'                                       |
         '----.                                         |
            | |                                         |
      .-----------------.                               |
      |  0x8000089 (.)  |                               |
      `-----------------'                               |
          v                                             |
          |                                             |
          |                                             |
      .-----------------.                               |
      |  0x800008e (j)  |                               |
      `-----------------'                               |
          v                                             |
          |                                             |
          '---------------------.                       |
                                | .---------------------'
                                | |
                          .-----------------.
                          |  0x8000092 (.)  |
                          `-----------------'
                              v
                              |
                              |
                          .-----------------.
                          |  0x8000093 (r)  |
                          `-----------------'
EOF
RUN


NAME=Test CFG generation - self reference
FILE=bins/elf/analysis/x86_cfg_test
CMDS=<<EOF
s sym.endless
agF
EOF
EXPECT=<<EOF
 .-----------------.
 |  0x8000094 (e)  |
 `-----------------'
     v
     |
     |
 .-----------------.
 |  0x8000095 (.)  |
 `-----------------'
     v
     |
     '----.
          |
          |
          |
       .--'
.--------.
|      | |
|.-----------------.
||  0x8000098 (j)  |
|`-----------------'
|    v
|    |
`----'
EOF
RUN

NAME=Test CFG generation - ignore calls
FILE=bins/elf/analysis/x86_cfg_test
CMDS=<<EOF
s sym.ignore_call
agF
EOF
EXPECT=<<EOF
.-----------------.
|  0x80000c3 (e)  |
`-----------------'
    v
    |
    |
.-----------------.
|  0x80000c4 (.)  |
`-----------------'
    v
    |
    |
.-----------------.
|  0x80000c7 (C)  |
`-----------------'
    v
    |
    |
.-----------------.
|  0x80000cc (.)  |
`-----------------'
    v
    |
    |
.-----------------.
|  0x80000cd (.)  |
`-----------------'
    v
    |
    |
.-----------------.
|  0x80000ce (r)  |
`-----------------'
EOF
RUN


NAME=Test CFG generation - loop
FILE=bins/elf/analysis/x86_cfg_test
CMDS=<<EOF
s sym.loop
agF
EOF
EXPECT=<<EOF
             .-----------------.
             |  0x800009a (e)  |
             `-----------------'
                 v
                 |
                 |
             .-----------------.
             |  0x800009b (.)  |
             `-----------------'
                 v
                 |
                 |
             .-----------------.
             |  0x800009e (.)  |
             `-----------------'
                 v
                 |
                 '-. .----------------------.
                   | |                      |
             .-----------------.            |
             |  0x80000a5 (.)  |            |
             `-----------------'            |
                 v                          |
                 |                          |
                 |                          |
             .-----------------.            |
             |  0x80000ac (j)  |            |
             `-----------------'            |
                 v                          |
                 |                          |
 .-------------------.                      |
 |                 | |                      |
 |           .-----------------.            |
 |           |  0x80000b7 (.)  |            |
 |           `-----------------'            |
 |               v                          |
 |               |                          |
 |              .'                          |
 |              |                           |
 |          .------------------.            |
 |          |  0x80000bb (jc)  |            |
 |          `------------------'            |
 |                t f                       |
 |                | |                       |
 |    .-----------' |                       |
 |    |             '-------.               |
 |    |                     |               |
 |.-----------------.   .-----------------. |
 ||  0x80000ae (.)  |   |  0x80000bd (.)  | |
 |`-----------------'   `-----------------' |
 |    v                     v               |
 |    |                     |               |
 |    |                     |               |
 |.-----------------.   .-----------------. |
 ||  0x80000b2 (.)  |   |  0x80000c1 (j)  | |
 |`-----------------'   `-----------------' |
 |    v                     v               |
 |    |                     |               |
 |    |                     `---------------'
 |    |
 |.-----------------.
 ||  0x80000b3 (.)  |
 |`-----------------'
 |    v
 |    |
 `----'
EOF
RUN

NAME=Test CFG generation - invalid
FILE=bins/elf/analysis/x86_cfg_test
CMDS=<<EOF
s 0x0
agF
s 0xffffffffffffffff
agF
EOF
EXPECT=<<EOF
.------------.
|  0x0 (eE)  |
`------------'
.---------------------------.
|  0xffffffffffffffff (eE)  |
`---------------------------'
EOF
RUN

NAME=CFG generation jumps beyond buffer
FILE==
CMDS=<<EOF
e asm.arch=x86
e analysis.arch=x86
wx 4839f87466e8900000000000488d3def000000488d3def000000488d3def000000488d3def000000488d3def000000488d3def000000488d3def000000488d3def000000488d3def000000488d3def000000488d3def000000488d3def000000488d3def00000000000000e890000000c3
agF
EOF
EXPECT=<<EOF
      .-----------.
      |  0x0 (e)  |
      `-----------'
          v
          |
         .'
         |
     .------------.
     |  0x3 (jc)  |
     `------------'
             f t
             | |
             | '--.
     .-------'    |
     |            |
 .-----------.    |
 |  0x5 (C)  |    |
 `-----------'    |
     v            |
     |            |
     |            |
 .-----------.    |
 |  0xa (.)  |    |
 `-----------'    |
     v            |
     |            |
     |            |
 .-----------.    |
 |  0xc (.)  |    |
 `-----------'    |
     v            |
     |            |
    .'            |
    |             |
.------------.    |
|  0x13 (.)  |    |
`------------'    |
    v             |
    |             |
    |             |
.------------.    |
|  0x1a (.)  |    |
`------------'    |
    v             |
    |             |
    |             |
.------------.    |
|  0x21 (.)  |    |
`------------'    |
    v             |
    |             |
    |             |
.------------.    |
|  0x28 (.)  |    |
`------------'    |
    v             |
    |             |
    |             |
.------------.    |
|  0x2f (.)  |    |
`------------'    |
    v             |
    |             |
    |             |
.------------.    |
|  0x36 (.)  |    |
`------------'    |
    v             |
    |             |
    |             |
.------------.    |
|  0x3d (.)  |    |
`------------'    |
    v             |
    |             |
    |             |
.------------.    |
|  0x44 (.)  |    |
`------------'    |
    v             |
    |             |
    |             |
.------------.    |
|  0x4b (.)  |    |
`------------'    |
    v             |
    |             |
    |             |
.------------.    |
|  0x52 (.)  |    |
`------------'    |
    v             |
    |             |
    |             |
.------------.    |
|  0x59 (.)  |    |
`------------'    |
    v             |
    |             |
    |             |
.------------.    |
|  0x60 (.)  |    |
`------------'    |
    v             |
    |             |
    |             |
.------------.    |
|  0x67 (.)  |    |
`------------'    |
    v             |
    |             |
    |             |
.------------.    |
|  0x69 (.)  |    |
`------------'    |
    v             |
    |             |
    '------.      |
           | .----'
           | |
     .------------.
     |  0x6b (C)  |
     `------------'
         v
         |
         |
     .------------.
     |  0x70 (r)  |
     `------------'
EOF
RUN

NAME=Test iCFG generation - iCFG with malloc
FILE=bins/elf/analysis/x86_icfg_malloc_test
CMDS=<<EOF
aa
agCi
EOF
EXPECT=<<EOF
.----------.    .----------.    .----------.    .----------.    .----------.    .----------.    .----------.
|  0x1070  |    |  0x10d0  |    |  0x1110  |    |  0x1150  |    |  0x11cc  |    |  0x11b4  |    |  0x1000  |
`----------'    `----------'    `----------'    `----------'    `----------'    `----------'    `----------'
                                      t                                               t
                                      |                                               |
                              .-------|                                               |
                              |       '-------.                                       |
                              |               |                                       |
                        .----------.    .----------.                            .----------.
                        |  0x10a0  |    |  0x1060  |                            |  0x1159  |
                        `----------'    `----------'                            `----------'
                                                                                      v
                                                                                      |
                                                      .-------------------------------|
                                                      |                       .-------|
                                                      |                       |       '---------------.
                                                      |                       |                       |
                                                .------------------.    .------------------.    .------------------.
                                                |  0x1040 (alloc)  |    |  0x1030 (alloc)  |    |  0x1050 (alloc)  |
                                                `------------------'    `------------------'    `------------------'
EOF
RUN

NAME=Test CFG generation of instruction words.
FILE=bins/elf/analysis/hexagon-hello-loop
CMDS=<<EOF
s sym.sys_Tlsalloc
agF
EOF
EXPECT=<<EOF
           .---------------.
           |  0x5388 (ec)  |
           `---------------'
                 t f
                 | |
    .------------' |
    |              '------.
    |                     |
.--------------.      .--------------.
|  0x53dc (.)  |      |  0x5390 (.)  |
`--------------'      `--------------'
    v                     v
    |                     |
    '---.                 |
        |                 |
        |             .--------------.
        |             |  0x539c (.)  |
        |             `--------------'
        |                 v
        |                 |
        |                 |
        |             .--------------.
        |             |  0x53ac (.)  |
        |             `--------------'
        |                 v
        |                 |
        |                 '-. .------------------.
        |                   | |                  |
        |             .--------------.           |
        |             |  0x53b4 (c)  |           |
        |             `--------------'           |
        |                   t f                  |
        |                   | |                  |
        |       .-----------' |                  |
        |       |             '-----.            |
        |       |                   |            |
        |   .--------------.    .--------------. |
        |   |  0x53e0 (.)  |    |  0x53bc (.)  | |
        |   `--------------'    `--------------' |
        |       v                   v            |
        |       |                   |            |
        |       |                   |            |
        |   .--------------.    .--------------. |
        |   |  0x53e4 (.)  |    |  0x53c8 (c)  | |
        |   `--------------'    `--------------' |
        |       v                     t f        |
        |       |                     | |        |
        |       |                     `----------'
        |       |                   .---'
        |   .--------------.    .--------------.
        |   |  0x53e8 (.)  |    |  0x53d8 (.)  |
        |   `--------------'    `--------------'
        |       v                   v
        |       |                   |
        |       |               .---'
        |       |               |
        |   .--------------.    |
        |   |  0x53ec (.)  |    |
        |   `--------------'    |
        |       v               |
        |       |               |
        |       '-------.       |
        |               | .-----'
        |               | |
        |         .--------------.
        |         |  0x53f8 (.)  |
        |         `--------------'
        |             v
        |             |
        |      .------'
        '--------.
               | |
         .--------------.
         |  0x5404 (r)  |
         `--------------'
EOF
RUN

NAME=Test CFG generation - invalid iwords
FILE=bins/elf/analysis/hexagon-hello-loop
CMDS=<<EOF
s 0x5000000000
agF
s 0xffffffffffffffff
agF
EOF
EXPECT=<<EOF
.-----------.
|  0x0 (e)  |
`-----------'
.-----------.
|  0x0 (e)  |
`-----------'
EOF
RUN

NAME=Test CFG generation of instruction words json
FILE=bins/elf/analysis/hexagon-hello-loop
CMDS=<<EOF
s sym.sys_Tlsalloc
agF json
EOF
EXPECT=<<EOF
{"nodes":[{"id":0,"address":21384,"is_entry":true,"is_return":false,"is_cond":true,"instructions":[{"address":21384},{"address":21388}],"out_nodes":[1,2]},{"id":1,"address":21468,"is_entry":false,"is_return":false,"is_cond":false,"instructions":[{"address":21468}],"out_nodes":[11]},{"id":2,"address":21392,"is_entry":false,"is_return":false,"is_cond":false,"instructions":[{"address":21392,"call_address":21824},{"address":21396},{"address":21400}],"out_nodes":[3]},{"id":3,"address":21404,"is_entry":false,"is_return":false,"is_cond":false,"instructions":[{"address":21404},{"address":21408},{"address":21412},{"address":21416}],"out_nodes":[4]},{"id":4,"address":21420,"is_entry":false,"is_return":false,"is_cond":false,"instructions":[{"address":21420},{"address":21424}],"out_nodes":[5]},{"id":5,"address":21428,"is_entry":false,"is_return":false,"is_cond":true,"instructions":[{"address":21428},{"address":21432}],"out_nodes":[6,7]},{"id":6,"address":21472,"is_entry":false,"is_return":false,"is_cond":false,"instructions":[{"address":21472}],"out_nodes":[12]},{"id":7,"address":21436,"is_entry":false,"is_return":false,"is_cond":false,"instructions":[{"address":21436},{"address":21440},{"address":21444}],"out_nodes":[8]},{"id":8,"address":21448,"is_entry":false,"is_return":false,"is_cond":true,"instructions":[{"address":21448},{"address":21452},{"address":21456},{"address":21460}],"out_nodes":[5,9]},{"id":9,"address":21464,"is_entry":false,"is_return":false,"is_cond":false,"instructions":[{"address":21464}],"out_nodes":[10]},{"id":10,"address":21496,"is_entry":false,"is_return":false,"is_cond":false,"instructions":[{"address":21496,"call_address":21888},{"address":21500},{"address":21504}],"out_nodes":[11]},{"id":11,"address":21508,"is_entry":false,"is_return":true,"is_cond":false,"instructions":[{"address":21508},{"address":21512},{"address":21516}],"out_nodes":[]},{"id":12,"address":21476,"is_entry":false,"is_return":false,"is_cond":false,"instructions":[{"address":21476}],"out_nodes":[13]},{"id":13,"address":21480,"is_entry":false,"is_return":false,"is_cond":false,"instructions":[{"address":21480}],"out_nodes":[14]},{"id":14,"address":21484,"is_entry":false,"is_return":false,"is_cond":false,"instructions":[{"address":21484},{"address":21488},{"address":21492}],"out_nodes":[10]}]}
EOF
RUN

NAME=hexagon tail calls
FILE=bins/elf/analysis/hexagon-hello-loop
CMDS=<<EOF
s 0x00008f04
af
pdf
agFf
EOF
EXPECT=<<EOF
/ sym._Mbtowc();
|           0x00008f04      ?       R17:16 = combine(R2,R3)
|           0x00008f08      ?       memd(R29+#-0x10) = R17:16 ; allocframe(#0x10)
|           0x00008f0c      [   R4 = memw(GP+##0x18)
|           0x00008f10      /       R19:18 = combine(R0,R1)
|           0x00008f14      \       memd(SP+##0x0) = R19:18
|       ,=< 0x00008f18      [   P0 = cmp.eq(R4,#0x0); if (P0.new) jump:nt 0x8f20
|       |   0x00008f1c      [   callr R4
|       `-> 0x00008f20      /       R1:0 = combine(R18,R19)
|           0x00008f24      |       R3:2 = combine(R16,R17)
|           0x00008f28      |       immext(##0xd980)
|           0x00008f2c      \       R4 = ##obj._Mbstate
|           0x00008f30      [   R17:16 = memd(R29+#0x8) ; R19:18 = memd(R29+#0x0)
|           0x00008f34      /       jump sym._Mbtowcx
\           0x00008f38      \       LR:FP = deallocframe(FP):raw
      .--------------.
      |  0x8f04 (e)  |
      `--------------'
          v
          |
          |
      .--------------.
      |  0x8f0c (.)  |
      `--------------'
          v
          |
          |
      .--------------.
      |  0x8f10 (.)  |
      `--------------'
          v
          |
          |
      .--------------.
      |  0x8f18 (c)  |
      `--------------'
            t f
            | |
    .-------' |
    |         '-----.
    |               |
.--------------.    |
|  0x8f1c (.)  |    |
`--------------'    |
    v               |
    |               |
    '-------.       |
            | .-----'
            | |
      .--------------.
      |  0x8f20 (.)  |
      `--------------'
          v
          |
          |
      .--------------.
      |  0x8f30 (.)  |
      `--------------'
          v
          |
          |
      .---------------.
      |  0x8f34 (rt)  |
      `---------------'
EOF
RUN

NAME=x86 tail call
FILE=bins/pe/bcc1.ex
CMDS=<<EOF
af
pdf
agFf
EOF
EXPECT=<<EOF
            ;-- section..text:
/ entry0();
|       ,=< 0x00401000      jmp   0x401012                             ; [00] -r-x section size 65536 named .text
..
|      ||   ; CODE XREF from entry0 @ 0x401000
|      |`-> 0x00401012      mov   eax, dword [0x411133]                ; [0x411133:4]=0
|      |    0x00401017      shl   eax, 2
|      |    0x0040101a      mov   dword [0x411137], eax                ; [0x411137:4]=0
|      |    0x0040101f      push  edx
|      |    0x00401020      push  0
|      |    0x00401022      call  sub.KERNEL32.DLL_GetModuleHandleA
|      |    0x00401027      mov   edx, eax
|      |    0x00401029      call  fcn.0040710c
|      |    0x0040102e      pop   edx
|      |    0x0040102f      call  fcn.004064a8
|      |    0x00401034      call  fcn.00407110
|      |    0x00401039      push  0
|      |    0x0040103b      call  fcn.00408058
|      |    0x00401040      pop   ecx
|      |    0x00401041      push  0x4110dc
|      |    0x00401046      push  0
|      |    0x00401048      call  sub.KERNEL32.DLL_GetModuleHandleA
|      |    0x0040104d      mov   dword [0x41113b], eax                ; [0x41113b:4]=0
|      |    0x00401052      push  0
\      |,=< 0x00401054      jmp   fcn.0040dfd0
.-----------------.
|  0x401000 (je)  |
`-----------------'
    v
    |
    |
.----------------.
|  0x401012 (.)  |
`----------------'
    v
    |
    |
.----------------.
|  0x401017 (.)  |
`----------------'
    v
    |
    |
.----------------.
|  0x40101a (.)  |
`----------------'
    v
    |
    |
.----------------.
|  0x40101f (.)  |
`----------------'
    v
    |
    |
.----------------.
|  0x401020 (.)  |
`----------------'
    v
    |
    |
.----------------.
|  0x401022 (C)  |
`----------------'
    v
    |
    |
.----------------.
|  0x401027 (.)  |
`----------------'
    v
    |
    |
.----------------.
|  0x401029 (C)  |
`----------------'
    v
    |
    |
.----------------.
|  0x40102e (.)  |
`----------------'
    v
    |
    |
.----------------.
|  0x40102f (C)  |
`----------------'
    v
    |
    |
.----------------.
|  0x401034 (C)  |
`----------------'
    v
    |
    |
.----------------.
|  0x401039 (.)  |
`----------------'
    v
    |
    |
.----------------.
|  0x40103b (C)  |
`----------------'
    v
    |
    |
.----------------.
|  0x401040 (.)  |
`----------------'
    v
    |
    |
.----------------.
|  0x401041 (.)  |
`----------------'
    v
    |
    |
.----------------.
|  0x401046 (.)  |
`----------------'
    v
    |
    |
.----------------.
|  0x401048 (C)  |
`----------------'
    v
    |
    |
.----------------.
|  0x40104d (.)  |
`----------------'
    v
    |
    |
.----------------.
|  0x401052 (.)  |
`----------------'
    v
    |
    |
.-----------------.
|  0x401054 (jt)  |
`-----------------'
EOF
RUN

NAME=aarch64 tail call
FILE=bins/elf/static-glibc-2.27
CMDS=<<EOF
s 0x00401ae0
af
pdf
agFf
EOF
EXPECT=<<EOF
/ fcn.00401ae0(int64_t arg1, int64_t arg2, int64_t arg3);
|           ; arg int64_t arg1 @ rdi
|           ; arg int64_t arg2 @ rsi
|           ; arg int64_t arg3 @ rdx
|           0x00401ae0      mov   r9d, edx                             ; arg3
|           0x00401ae3      xor   r8d, r8d
|           0x00401ae6      xor   ecx, ecx
|           0x00401ae8      xor   edx, edx
\       ,=< 0x00401aea      jmp   fcn.00402f40
.----------------.
|  0x401ae0 (e)  |
`----------------'
    v
    |
    |
.----------------.
|  0x401ae3 (.)  |
`----------------'
    v
    |
    |
.----------------.
|  0x401ae6 (.)  |
`----------------'
    v
    |
    |
.----------------.
|  0x401ae8 (.)  |
`----------------'
    v
    |
    |
.-----------------.
|  0x401aea (jt)  |
`-----------------'
EOF
RUN

NAME=x86 tail call - exit
FILE=bins/elf/vim
CMDS=<<EOF
af @ sym.main_loop
s 0x002175f1
af
pdf
agFf
EOF
EXPECT=<<EOF
/ fcn.002175f1(int64_t arg_8h);
|     :::   ; arg int64_t arg_8h @ stack + 0x8
|     :::   0x002175f1      mov   rax, qword [arg_8h]
|     :::   0x002175f6      xor   rax, qword fs:[0x28]
|    ,====< 0x002175ff      jne   0x217665
|    |:::   0x00217601      add   rsp, 0x18
|    |:::   0x00217605      pop   rbx
|    |:::   0x00217606      pop   rbp
|    |:::   0x00217607      ret
..
\    `----> 0x00217665      call  sym.imp.__stack_chk_fail             ; void __stack_chk_fail(void)
           .----------------.
           |  0x2175f1 (e)  |
           `----------------'
               v
               |
               |
           .----------------.
           |  0x2175f6 (.)  |
           `----------------'
               v
               |
               |
           .-----------------.
           |  0x2175ff (jc)  |
           `-----------------'
                 t f
                 | |
    .------------' |
    |              '------.
    |                     |
.-----------------.   .----------------.
|  0x217665 (CE)  |   |  0x217601 (.)  |
`-----------------'   `----------------'
                          v
                          |
                          |
                      .----------------.
                      |  0x217605 (.)  |
                      `----------------'
                          v
                          |
                          |
                      .----------------.
                      |  0x217606 (.)  |
                      `----------------'
                          v
                          |
                          |
                      .----------------.
                      |  0x217607 (r)  |
                      `----------------'
EOF
RUN

NAME=arm tail call no target
FILE=bins/elf/analysis/arm-ls
CMDS=<<EOF
s 0x00011ba4
af
pdf
agFf
EOF
EXPECT=<<EOF
/ void sym.imp.error(int status, int errname, char *format);
|           0x00011ba4      add   ip, pc, 0, 12
|           0x00011ba8      add   ip, ip, 0x25000
\           0x00011bac      ldr   pc, [ip, 0x528]!
 .---------------.
 |  0x11ba4 (e)  |
 `---------------'
     v
     |
     |
 .---------------.
 |  0x11ba8 (.)  |
 `---------------'
     v
     |
    .'
    |
.----------------.
|  0x11bac (jt)  |
`----------------'
EOF
RUN
